---
permalink: tools-apps-guides/elasticsearch-snapshot-configuration.html 
sidebar: sidebar 
keywords: Elastic, Elasticsearch, snapshot, repository, StorageGRID, object storage 
summary: StorageGRIDオブジェクト ストレージを使用するための Elasticsearch スナップショット リポジトリを作成する手順。 
---
= Elasticsearch スナップショットリポジトリの構成
:hardbreaks:
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
Angela Cheng著_

Elasticsearch は、スナップショット リポジトリに AWS S3 互換オブジェクト ストレージの使用をサポートしています。この記事では、 StorageGRID をバックエンド オブジェクト ストレージとして使用して Elasticsearch S3 スナップショット リポジトリを作成する手順を段階的に説明します。



== 要件

* StorageGRID 11.8以降
* Elasticsearch 8.x 以上




== 前提条件

読者は、 StorageGRIDおよび Elasticsearch の用語と操作に精通しています。



== 指示

* 手順 *

. Elasticsearch スナップショット リポジトリに使用するStorageGRIDバケットを作成します。バケットのバージョン管理を有効にする必要があります。リポジトリごとに 1 つのバケットを使用します。複数のリポジトリまたは Elasticsearch クラスター間でバケットを共有しないでください。
. StorageGRIDテナント アクセス キーとシークレット キーを Elasticsearch キーストアに追加します。  Elasticsearchマスターノードにログインし、 `<elasticsearch>/bin/`ディレクトリ、および使用 `elasticsearch-keystore`アクセス キーとシークレット キーを追加します。
+
サンプルコマンド:

+
[NOTE]
====
 In older Elasticsearch versions, the key names are `access.key` and `secret.key` instead of using underscores.
====
+
[listing]
----
/usr/share/elasticsearch/bin/elasticsearch-keystore add s3.client.sgdemo.access_key
Enter value for s3.client.sgdemo.access_key: <paste the access key here, it will not be displayed>

/usr/share/elasticsearch/bin/elasticsearch-keystore add s3.client.sgdemo.secret_key
Enter value for s3.client.sgdemo.secret_key: <paste the secret key here, it will not be displayed>
----
+
キーを表示するには、「elasticsearch-keystore show <key-name>」コマンドを使用します。

. マルチノード Elasticsearch クラスターの場合は、各ノードで手順 2 を繰り返すか、Elasticsearch のドキュメントを参照してください。
. KibanaのWeb GUIから、開発ツールコンソールページに移動し、 `POST _nodes/reload_secure_settings`各ノードに変更を適用するための API。
+
image:es-snapshot/es-reload-api.png["reload_secure_settings サンプルスクリーンショット"]

. 使用 `PUT _snapshot`新しいスナップショット リポジトリを作成するための API。
+
この例では、リポジトリ名は `sg_snapshot_repository`バッファ サイズは S3 マルチパートアップロード パート サイズに対応します。

+
デフォルトのプロトコルは HTTPS です。  StorageGRID S3エンドポイントでHTTPを使用するには、 `"protocol": "http"`設定に。

+
手順 1 で作成したバケット名と手順 2 で設定したクライアント名を使用します。

+
[listing]
----
PUT _snapshot/sg_snapshot_repository
{
  "type": "s3",
  "settings": {
    "bucket": "elk-snapshot",
    "client": "sgdemo",
    "path_style_access": "true",
    "endpoint": "sgdemo.netapp.com",
    "buffer_size": "512mb"
  }
}
----
+
image:es-snapshot/es-create-repository-api.png["Elasticsearch API サンプルのスクリーンショット"]

. Kibana Web GUI から、「スタック管理」>「スナップショットと復元」ページに移動し、「リポジトリ」タブを選択します。
+
リポジトリ名をクリックすると詳細が表示され、Elasticsearch ノードごとにデフォルトで 40 MB/秒に設定されている最大スナップショット バイト数などの設定を変更できます。

+
このページに表示されない設定については、 `PUT _snapshot`変更を加えるには、開発ツール コンソールの API を使用します。

+
image:es-snapshot/es-snapshot-repository.png["スナップショットリポジトリのサンプルスクリーンショット"]

. スナップショット バケット内の現在のバージョン以外のオブジェクトを管理するためのバケット ライフサイクル ポリシーを設定します。たとえば、90 日後に最新ではないバージョンを削除します。
. Elastic では、スナップショットを保存するために非 AWS S3 ストレージを使用する前に、クライアントがそれを検証する必要があります。
+
セットアップを検証するには、Elastic の指示に従ってください。

+
https://www.elastic.co/docs/api/doc/elasticsearch/operation/operation-snapshot-repository-analyze[]

. 検証後、Elasticsearch ガイドに従って、夜間スナップショットを保存するためのポリシーを作成します。




== その他のリソース

* https://www.elastic.co/docs/api/doc/elasticsearch/group/endpoint-snapshot["Elasticsearch s3リポジトリ"]
* https://docs.netapp.com/us-en/storagegrid/ilm/how-objects-are-deleted.html#delete-s3-versioned-objects["S3 バージョン管理オブジェクトの削除方法"]

